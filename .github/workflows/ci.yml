name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc-11
            cxx: g++-11
          - compiler: clang
            cc: clang-14
            cxx: clang++-14

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DFALCON_BUILD_TESTS=ON \
            -DFALCON_BUILD_CLI=ON \
            -DFALCON_ENABLE_HTTP=ON \
            -DFALCON_ENABLE_FTP=OFF \
            -DFALCON_BUILD_DAEMON=OFF \
            -DFALCON_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -j $(nproc)

      - name: Run tests
        working-directory: build
        run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake ninja curl

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DFALCON_BUILD_TESTS=ON \
            -DFALCON_BUILD_CLI=ON \
            -DFALCON_ENABLE_HTTP=ON \
            -DFALCON_ENABLE_FTP=OFF \
            -DFALCON_BUILD_DAEMON=OFF \
            -DFALCON_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -j $(sysctl -n hw.ncpu)

      - name: Run tests
        working-directory: build
        run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg integrate install

      - name: Install dependencies
        run: |
          .\vcpkg\vcpkg install curl:x64-windows

      - name: Configure CMake
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake `
            -DFALCON_BUILD_TESTS=ON `
            -DFALCON_BUILD_CLI=ON `
            -DFALCON_ENABLE_HTTP=ON `
            -DFALCON_ENABLE_FTP=OFF `
            -DFALCON_BUILD_DAEMON=OFF `
            -DFALCON_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -j $env:NUMBER_OF_PROCESSORS

      - name: Run tests
        working-directory: build
        run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

  code-quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get install -y clang-format-14

      - name: Check code formatting
        run: |
          find packages -name "*.cpp" -o -name "*.hpp" | head -20 | xargs clang-format-14 --dry-run --Werror || echo "Code formatting check completed"
